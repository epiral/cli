syntax = "proto3";

package epiral.v1;

// Agent 侧 gRPC Server — CLI 连上来建立双向命令通道
service HubService {
  rpc Connect(stream ConnectRequest) returns (stream ConnectResponse);
}

// ==================== 上行消息 (CLI → Agent) ====================

message ConnectRequest {
  string request_id = 1;

  oneof payload {
    // Computer
    Registration registration = 10;
    ExecOutput   exec_output  = 11;
    FileContent  file_content = 12;
    OpResult     op_result    = 13;
    Ping         ping         = 14;
    // Browser
    BrowserRegistration browser_registration = 15;
    BrowserExecOutput   browser_exec_output  = 16;
  }
}

// ==================== Computer 注册 ====================

// 首次连接：我是谁（电脑）
message Registration {
  string computer_id              = 1;  // --computer-id "my-pc"
  string description              = 2;  // --computer-desc "Mac Studio M2 Ultra"
  string os                       = 3;  // "darwin" | "linux"
  string arch                     = 4;  // "arm64" | "amd64"
  string shell                    = 5;  // "/bin/zsh"
  string home_dir                 = 6;  // "/Users/xx"
  map<string, string> tools       = 7;  // {"go": "1.22", "node": "22.13"}
  repeated string allowed_paths   = 8;  // ["/Users/xx/workspace", "/tmp"]
  string token                    = 9;  // 认证 token
}

// ==================== Browser 注册 ====================

// 浏览器上线/下线通知
message BrowserRegistration {
  string browser_id  = 1;  // --browser-id "my-chrome"
  string description = 2;  // --browser-desc "My Chrome Browser"
  bool   online      = 3;  // true=插件已连接 SSE, false=插件断开
}

// ==================== Computer 上行响应 ====================

// 命令执行输出（流式：多条消息，done=true 结束）
message ExecOutput {
  string stdout    = 1;
  string stderr    = 2;
  int32  exit_code = 3;
  bool   done      = 4;  // true = 最后一条
  string workdir   = 5;  // 执行后的 cwd
}

// 文件读取结果
message FileContent {
  string content     = 1;
  int64  total_lines = 2;
  int64  file_size   = 3;  // 实际文件大小（字节）
  string error       = 4;  // 非空表示失败
}

// 写入/编辑等操作结果
message OpResult {
  bool   success = 1;
  string error   = 2;
}

// ==================== Browser 上行响应 ====================

// 浏览器命令执行结果
message BrowserExecOutput {
  string result_json = 1;  // 插件回传的 Response JSON（bb-browser 协议）
  string error       = 2;  // daemon 级别的错误（插件未连接/超时等）
  bool   done        = 3;
}

// ==================== 心跳 ====================

message Ping {
  int64 timestamp = 1;
}

message Pong {
  int64 timestamp = 1;
}

// ==================== 下行消息 (Agent → CLI) ====================

message ConnectResponse {
  string request_id = 1;

  oneof payload {
    // Computer
    ExecRequest      exec       = 10;
    ReadFileRequest  read_file  = 11;
    WriteFileRequest write_file = 12;
    EditFileRequest  edit_file  = 13;
    Pong             pong       = 14;
    // Browser
    BrowserExecRequest browser_exec = 15;
  }
}

// ==================== Computer 下行命令 ====================

// 执行命令
message ExecRequest {
  string command    = 1;
  string workdir    = 2;  // 工作目录（空 = home_dir）
  int32  timeout_ms = 3;  // 超时毫秒（0 = 默认 30000）
  string session_id = 4;  // Shell Pool 用，空 = one-shot (P1)
}

// 读文件
message ReadFileRequest {
  string path     = 1;
  int32  offset   = 2;  // 行偏移（0-based）
  int32  limit    = 3;  // 行数（0 = 全部，默认 2000）
  int64  max_size = 4;  // 字节上限（0 = 默认 256KB）
}

// 写文件
message WriteFileRequest {
  string path    = 1;
  string content = 2;
}

// 编辑文件（查找替换）
message EditFileRequest {
  string path        = 1;
  string old_string  = 2;
  string new_string  = 3;
  bool   replace_all = 4;
}

// ==================== Browser 下行命令 ====================

// 浏览器命令（转发给插件执行）
message BrowserExecRequest {
  string command_json = 1;  // 结构化命令 JSON（bb-browser Request 协议）
  int32  timeout_ms   = 2;  // 超时毫秒（0 = 默认 30000）
}
